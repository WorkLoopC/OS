#include <stdint.h>
#include "limine.h"

static volatile struct limine_framebuffer_request fb_request = {    //frame buffer z limine.h
    .id = LIMINE_FRAMEBUFFER_REQUEST,
    .revision = 0
};

// ---------- 8x8 FONT (ASCII 32-127) ----------
uint8_t font8x8_basic[128][8] = {
    [32] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // space
    [33] = {0x18,0x18,0x18,0x18,0x18,0x00,0x18,0x00}, // !
    [34] = {0x36,0x36,0x24,0x00,0x00,0x00,0x00,0x00}, // "
    [35] = {0x36,0x36,0x7F,0x36,0x7F,0x36,0x36,0x00}, // #
    [36] = {0x0C,0x3E,0x03,0x1E,0x30,0x1F,0x0C,0x00}, // $
    [37] = {0x00,0x63,0x33,0x18,0x0C,0x66,0x63,0x00}, // %
    [38] = {0x1C,0x36,0x1C,0x6E,0x3B,0x33,0x6E,0x00}, // &
    [39] = {0x06,0x06,0x03,0x00,0x00,0x00,0x00,0x00}, // '
    [40] = {0x0C,0x06,0x03,0x03,0x03,0x06,0x0C,0x00}, //(
    [41] = {0x03,0x06,0x0C,0x0C,0x0C,0x06,0x03,0x00}, //)
    [42] = {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00}, // *
    [43] = {0x00,0x0C,0x0C,0x3F,0x0C,0x0C,0x00,0x00}, // +
    [44] = {0x00,0x00,0x00,0x00,0x0C,0x0C,0x06,0x00}, // ,
    [45] = {0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00}, // -
    [46] = {0x00,0x00,0x00,0x00,0x0C,0x0C,0x00,0x00}, // .
    [47] = {0x60,0x30,0x18,0x0C,0x06,0x03,0x01,0x00}, // /
    [48] = {0x3E,0x63,0x67,0x6F,0x7B,0x73,0x3E,0x00}, // 0
    [49] = {0x0C,0x0E,0x0C,0x0C,0x0C,0x0C,0x3F,0x00}, // 1
    [50] = {0x3E,0x63,0x30,0x18,0x0C,0x06,0x7F,0x00}, // 2
    [51] = {0x3E,0x63,0x30,0x1C,0x30,0x63,0x3E,0x00}, // 3
    [52] = {0x30,0x38,0x34,0x32,0x7F,0x30,0x78,0x00}, // 4
    [53] = {0x7F,0x03,0x3F,0x60,0x60,0x63,0x3E,0x00}, // 5
    [54] = {0x3C,0x06,0x03,0x3F,0x63,0x63,0x3E,0x00}, // 6
    [55] = {0x7F,0x63,0x30,0x18,0x0C,0x0C,0x0C,0x00}, // 7
    [56] = {0x3E,0x63,0x63,0x3E,0x63,0x63,0x3E,0x00}, // 8
    [57] = {0x3E,0x63,0x63,0x7E,0x60,0x30,0x1E,0x00}, // 9
    [65] = {0x18,0x3C,0x66,0x66,0x7E,0x66,0x66,0x00}, // A
    [66] = {0x7C,0x66,0x66,0x7C,0x66,0x66,0x7C,0x00}, // B
    [67] = {0x3C,0x66,0x60,0x60,0x60,0x66,0x3C,0x00}, // C
    [68] = {0x78,0x6C,0x66,0x66,0x66,0x6C,0x78,0x00}, // D
    [69] = {0x7E,0x60,0x60,0x7C,0x60,0x60,0x7E,0x00}, // E
    [70] = {0x7E,0x60,0x60,0x7C,0x60,0x60,0x60,0x00}, // F
    [71] = {0x3C,0x66,0x60,0x6E,0x66,0x66,0x3E,0x00}, // G
    [72] = {0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x00}, // H
    [73] = {0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00}, // I
    [74] = {0x1E,0x0C,0x0C,0x0C,0x0C,0x6C,0x38,0x00}, // J
    [75] = {0x66,0x6C,0x78,0x70,0x78,0x6C,0x66,0x00}, // K
    [76] = {0x60,0x60,0x60,0x60,0x60,0x60,0x7E,0x00}, // L
    [77] = {0x63,0x77,0x7F,0x6B,0x63,0x63,0x63,0x00}, // M
    [78] = {0x66,0x76,0x7E,0x7E,0x6E,0x66,0x66,0x00}, // N
    [79] = {0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00}, // O
    [80] = {0x7C,0x66,0x66,0x7C,0x60,0x60,0x60,0x00}, // P
    [81] = {0x3C,0x66,0x66,0x66,0x6E,0x3C,0x0E,0x00}, // Q
    [82] = {0x7C,0x66,0x66,0x7C,0x78,0x6C,0x66,0x00}, // R
    [83] = {0x3E,0x60,0x60,0x3C,0x06,0x06,0x7C,0x00}, // S
    [84] = {0x7E,0x5A,0x18,0x18,0x18,0x18,0x3C,0x00}, // T
    [85] = {0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00}, // U
    [86] = {0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00}, // V
    [87] = {0x63,0x63,0x63,0x6B,0x7F,0x77,0x63,0x00}, // W
    [88] = {0x66,0x66,0x3C,0x18,0x3C,0x66,0x66,0x00}, // X
    [89] = {0x66,0x66,0x66,0x3C,0x18,0x18,0x3C,0x00}, // Y
    [90] = {0x7E,0x06,0x0C,0x18,0x30,0x60,0x7E,0x00}, // Z
    [97] = {0x00,0x00,0x3C,0x06,0x3E,0x66,0x3E,0x00}, // a
    [98] = {0x60,0x60,0x7C,0x66,0x66,0x66,0x7C,0x00}, // b
    [99] = {0x00,0x00,0x3C,0x60,0x60,0x60,0x3C,0x00}, // c
    [100] = {0x06,0x06,0x3E,0x66,0x66,0x66,0x3E,0x00}, // d
    [101] = {0x00,0x00,0x3C,0x66,0x7E,0x60,0x3C,0x00}, // e
    [102] = {0x0E,0x18,0x18,0x3E,0x18,0x18,0x18,0x00}, // f
    [103] = {0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x3C}, // g
    [104] = {0x60,0x60,0x6C,0x76,0x66,0x66,0x66,0x00}, // h
    [105] = {0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00}, // i
    [106] = {0x0C,0x00,0x0C,0x0C,0x0C,0x6C,0x6C,0x38}, // j
    [107] = {0x60,0x60,0x66,0x6C,0x78,0x6C,0x66,0x00}, // k
    [108] = {0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00}, // l
    [109] = {0x00,0x00,0x33,0x7F,0x7F,0x6B,0x63,0x00}, // m
    [110] = {0x00,0x00,0x7C,0x66,0x66,0x66,0x66,0x00}, // n
    [111] = {0x00,0x00,0x3C,0x66,0x66,0x66,0x3C,0x00}, // o
    [112] = {0x00,0x00,0x7C,0x66,0x66,0x7C,0x60,0x60}, // p
    [113] = {0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x06}, // q
    [114] = {0x00,0x00,0x6C,0x76,0x60,0x60,0x60,0x00}, // r
    [115] = {0x00,0x00,0x3E,0x60,0x3C,0x06,0x7C,0x00}, // s
    [116] = {0x18,0x18,0x3E,0x18,0x18,0x18,0x0E,0x00}, // t
    [117] = {0x00,0x00,0x66,0x66,0x66,0x66,0x3E,0x00}, // u
    [118] = {0x00,0x00,0x66,0x66,0x66,0x3C,0x18,0x00}, // v
    [119] = {0x00,0x00,0x63,0x6B,0x7F,0x36,0x36,0x00}, // w
    [120] = {0x00,0x00,0x66,0x3C,0x18,0x3C,0x66,0x00}, // x
    [121] = {0x00,0x00,0x66,0x66,0x66,0x3E,0x06,0x3C}, // y
    [122] = {0x00,0x00,0x7E,0x0C,0x18,0x30,0x7E,0x00}, // z
    [63] = {0x3C,0x66,0x30,0x18,0x18,0x00,0x18,0x00}  // ?
};

// ---------- FRAMEBUFFER PRINTING ----------
struct fb {
    uint32_t* pixels;
    uint32_t width;
    uint32_t height;
    uint32_t pitch; 
};

struct fb framebuffer;

void fb_put_char(struct fb* fb, char c, uint32_t x, uint32_t y, uint32_t color) {
    if (c < 32 || c > 126) return;
    for (int row = 0; row < 8; row++) {
        uint8_t bits = font8x8_basic[(int)c][row];
        for (int col = 0; col < 8; col++) {
            if (bits & (1 << (7 - col))) { 
                int px = x + col;
                int py = y + row;
                if (px < fb->width && py < fb->height)
                    fb->pixels[py * fb->pitch + px] = color;
            }
        }
    }
}

void fb_puts_char(struct fb* fb, const char* str, uint32_t x, uint32_t y, uint32_t color) {
    if (!fb_request.response || fb_request.response->framebuffer_count < 1) {
        for (;;) __asm__("hlt");
    }

    struct limine_framebuffer* lim_fb = fb_request.response->framebuffers[0];
    framebuffer.pixels = (uint32_t*)lim_fb->address;
    framebuffer.width = lim_fb->width;
    framebuffer.height = lim_fb->height;
    framebuffer.pitch = lim_fb->pitch / (lim_fb->bpp / 8);
    while (*str) {
        fb_put_char(fb, *str, x, y, color);
        x += 8;
        str++;
        if (x + 8 > fb->width) { // wrap line
            x = 0;
            y += 8;
        }
    }
}

void itoa_hex(uintptr_t value, char* buffer) { //Funkce na konverzi stringu na int (pro print adres k debugovani memory managementu)
    char hex[] = "0123456789ABCDEF";
    buffer[0] = '0';
    buffer[1] = 'x';
    for (int i = 0; i < (sizeof(uintptr_t) * 2); i++) {
        int shift = ((sizeof(uintptr_t) * 2 - 1 - i) * 4);
        buffer[2 + i] = hex[(value >> shift) & 0xF];
    }

    buffer[2 + sizeof(uintptr_t) * 2] = '\0';
}
